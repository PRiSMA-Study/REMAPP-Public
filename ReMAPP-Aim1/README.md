# ReMAPP Aim 1 Analysis – Healthy Cohort Construction & Reference Hemoglobin Limits

## Description

This analytic pipeline supports ReMAPP Aim 1, which constructs a Healthy Pregnancy Cohort and models the non-linear relationship between gestational age (GA, weeks) and maternal hemoglobin (Hb, g/dL) during pregnancy. The primary analytic method is fractional polynomial regression (FPR), selected to flexibly capture complex, non-linear Hb–GA relationships that are not well represented by linear or standard polynomial models.

## Version control
#### :pushpin: Updated on 2026-01-14
#### :pushpin: Originally drafted by: Xiaoyan Hu (xyh@gwu.edu)
#### :pushpin: Modified and extended by: Precious Williams (williams_pj@gwu.edu)

## Script Order

### 1. `1_remapp_one_prep.R` — Data Preparation & Cohort Construction
This script performs all data loading, harmonization, eligibility determination, and derivation of analysis-ready datasets.
All output datasets generated by this pipeline are saved to: Analysis/ReMAPP/Aim1/<Data_Upload_Date>/derived_data/

**Key steps:**
* **Load and merge data**
  * Load stacked site-level MNH forms, maternal outcome data, and cached `.rda` files
  * Select and harmonize variables required for ReMAPP Aim 1 analyses   
* **Define healthy cohort criteria**
  * Derive all prespecified eligibility criteria across clinical, behavioral, laboratory, and anthropometric domains
* **Eligibility determination**
  * Apply criteria to define the primary healthy cohort and sensitivity cohort variants
  * Save both screening-level and participant-level eligibility outputs
* **Hemoglobin (Hb) data restructuring**
  * Prepare Hb data in both long and wide formats
  * Apply altitude and smoking adjustments
  * Exclude biologically implausible Hb values
* **Sensitivity analysis datasets**
  * Generate datasets for:
    * G6PD exclusion
    * Gestational age–based criteria
    * Preterm birth exclusion
* **Eligibility and missingness visualization inputs**
  * Prepare long-format eligibility indicators (C1–C20)
  * Support flow diagram construction and missingness visualization

### 2. `2_remapp_one_analysis.RMD` — Visualization & Modeling
This script performs exploratory data analysis and statistical modeling within the healthy cohort.

**Key components:**
* Descriptive visualization of hemoglobin distributions in the healthy cohort
* Fractional polynomial regression (FPR) modeling of hemoglobin by gestational age

### 3. `3_remapp_one_report_run.RMD` — Report Generation
This script orchestrates final report production.
**Functions:**
* Calls `2_remapp_one_analysis.RMD`
* Produces the ReMAPP Aim 1 report, integrating:
  * Healthy cohort construction
  * Hemoglobin centile estimation
  * Sensitivity analyses

## Dataset Description
### Source Datasets 
All source datasets are loaded from site-level stacked or outcome data and saved (cached) as `.rda` files to ensure computational efficiency.
#### Maternal & Screening Data
* **`MAT_ENROLL.rda`** – Maternal enrollment information and pregnancy start metadata
* **`MAT_FLOWCHART.rda`** – Screening and enrollment flow variables used to construct analytic denominators
* **`MAT_GWG.rda`** – Gestational weight gain and anthropometric data
* **`MAT_DEMOGRAPHIC.rda`** – Baseline demographic and socioeconomic characteristics
#### MNH Form Data
* **`mnh00.rda`** – Maternal age and date of birth (prescreening form)
* **`mnh03.rda`** – Smoking, alcohol, and substance use (sociodemographic form)
* **`mnh04_raw.rda`** – Obstetric and medical history (clinical history form)
* **`mnh05.rda`** – Anthropometry (weight, height, MUAC)
* **`mnh06.rda`** – Blood pressure and infectious disease rapid tests
* **`mnh08_raw.rda`** – Laboratory results (hemoglobin, ferritin, CRP, AGP, G6PD, hemoglobinopathies)
* **`mnh09.rda`** – Delivery information and infant identifiers
#### Infant Outcomes
* **`INF_OUTCOMES.rda`** – Infant outcomes used to derive maternal-level preterm birth indicators

### Intermediate Derived Datasets
These datasets harmonize maternal, laboratory, and screening data prior to eligibility determination.
* **`screen_df_clean.rda`** – Cleaned screening dataset identifying eligible ReMAPP participants
* **`df_maternal.rda`** – Fully merged maternal dataset combining enrollment data, MNH forms, laboratory results, and site-reported overrides
* **`df_criteria.rda`** – Maternal dataset containing all derived healthy cohort eligibility criteria (`CRIT_*`)
  
### Healthy Cohort Eligibility Outputs
Eligibility is defined using **20 prespecified criteria** (18 in use for analysis purposes, GA and G6PD criteria excluded) spanning clinical, anthropometric, laboratory, and behavioral domains.
* **`healthyOutcome.rda`** – Master eligibility dataset containing:
  * `HEALTHY_ELIGIBLE` – Primary healthy cohort definition
  * `HEALTHY_ELIGIBLE_GA` – Definition including gestational age as an eligibility criterion
  * `HEALTHY_ELIGIBLE_G6PD` – Definition excluding G6PD criterion
  * `HEALTHY_COHORT_COMP` – Complete-case healthy cohort definition
* **`df_healthy.rda`** – Participants meeting the primary healthy cohort definition
* **`all_screen.rda`** – Screening-level dataset for flow diagrams and exclusion accounting
* **`df_eli_long.rda`** – Long-format eligibility dataset (C1–C20) used for eligibility visualization and missingness assessment

### Hemoglobin (Hb) Analysis Datasets
Hemoglobin values are adjusted for altitude and smoking, cleaned for outliers, and restricted to biologically plausible ranges.
#### Long Format
* **`df_hb_long1_all.rda`** – All available hemoglobin measurements
* **`df_hb_long1_hc.rda`** – Hemoglobin measurements restricted to the healthy cohort
* **`df_hb_long1_g6pd.rda`** – Healthy cohort excluding the G6PD criterion
* **`df_hb_long1.rda`** – Final analysis-ready hemoglobin dataset
  * Gestational age range: **5–45 weeks**
  * Hemoglobin range: **5–18 g/dL**
#### Wide Format
* **`df_hb_wide1_all.rda`** – One row per pregnancy (all participants)
* **`df_hb_wide1_hc.rda`** – Restricted to the healthy cohort
* **`df_hb_wide1_g6pd.rda`** – Excluding the G6PD criterion
* **`df_hb_wide1.rda`** – Final wide hemoglobin dataset after outlier exclusion

### Sensitivity Analysis Dataset
* **`df_sensitive_long.rda`** – Hemoglobin dataset merged with infant outcomes, used for:
  * Fractional polynomial regression (FPR) modeling
  * Sensitivity analyses excluding preterm birth
  * Site-specific and pooled hemoglobin centile estimation




