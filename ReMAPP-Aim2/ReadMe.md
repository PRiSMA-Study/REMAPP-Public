
# ReMAPP Aim 2 – Isotonic & Spline Modeling Pipeline

This directory contains the full **Aim 2 analysis pipeline** for evaluating maternal hemoglobin (Hb) decision thresholds using 
**restricted cubic spline regression** and 
**isotonic regression**. 
The code is organized to support reproducible data preparation, outcome-specific modeling, automated plotting, and final report generation.

---

## Code Structure Overview

### `iso_code/` — Core Modeling Utilities

Shared functions sourced by all outcome scripts.

| File | Purpose |
|----|----|
| `iso_binary_25_mod.R` | Isotonic regression for **binary outcomes** using mixed-effects logistic models at **0.25 Hb bin resolution** |
| `iso_binary_50_mod.R` | Same as above, using **0.50 Hb bin resolution** |
| `iso_continuous_25.R` | Isotonic regression for **continuous outcomes** using linear mixed-effects models (0.25 resolution) |
| `iso_continuous_50.R` | Continuous isotonic regression at 0.50 resolution |
| `spline_binary_boot.R` | Restricted cubic spline models for binary outcomes with bootstrap uncertainty |
| `spline_continuous_boot.R` | Restricted cubic spline models for continuous outcomes with bootstrap uncertainty |
| `plot_boot.R` | Plotting functions for binary spline + isotonic results |
| `plot_boot_continuous.R` | Plotting functions for continuous spline + isotonic results |
| `outdata_mod.R` | Standardized storage and export of model outputs for tables|

---

### `1_data_prep_aim2` — Data Preparation

End-to-end preparation of Aim 2 datasets:

- Loads raw PRISMA/ReMAPP outcome data and stacked MNH forms
- Harmonizes visit timing and resolves duplicate measurements
- Adjusts hemoglobin for altitude and smoking
- Truncates Hb at clinically plausible extremes
- Selects one biologically meaningful Hb value per pregnancy per analysis window
- Produces analysis-ready maternal and infant datasets stratified by trimester and postpartum periods

All downstream scripts depend on outputs generated here.

---

### `2_*` — Outcome-Specific Modeling Scripts

Each `2_*` script is **self-contained** and performs the following steps:

1. Load outcome-specific analysis datasets
2. Run **restricted cubic spline models**
3. Run **isotonic regression models** (25 and/or 50 bin resolution)
4. Generate and save outcome-specific plots
5. Write standardized model outputs to the results directory

#### Infant Outcomes
- `2_inf_asph`
- `2_inf_compo`
- `2_inf_hyperbili`
- `2_inf_lbw1500`
- `2_inf_lbw2500`
- `2_inf_nmortality`
- `2_inf_preterm34`
- `2_inf_preterm37`
- `2_inf_psbi`
- `2_inf_sga3`
- `2_inf_sga10`
- `2_inf_stillbirth20`
- `2_inf_stillbirth28`

#### Maternal Outcomes
- `2_mat_compo`
- `2_mat_dpr`
- `2_mat_fat`
- `2_mat_ppa_pnc6`
- `2_mat_ppa_pnc26`
- `2_mat_pph`
- `2_mat_pprom`
- `2_mat_preclamp`

These scripts can be run **independently or in parallel**, depending on available computing resources (suggest running individually if laptop power is low).

---

### `3_remapp_aim_two_plots` — Plot Aggregation

- Collects plots generated by individual `2_*` scripts
- Assembles combined panels (e.g., trimester-based or outcome-grouped figures)
- Produces manuscript- and report-ready visual outputs

---

### `4_remapp_aim_two_report_run` — Final Report Execution

- Pulls compiled plots and modeling rmarkdownfile
- Generates the complete Aim 2 analysis report
- Used to better control the version of output file, when required

---

## Recommended Execution Order
1. `1_data_prep_aim2`  
2. Any or all `2_*` outcome scripts (order-independent)  
3. `3_remapp_aim_two_plots`  
4. `4_remapp_aim_two_report_run`  

---

## Modeling Context 
- Spline models capture smooth, non-linear associations between hemoglobin and outcomes.
- Isotonic regression identifies monotonic risk shifts and candidate decision thresholds.
- Both approaches are run per outcome using standardized utilities in `iso_code/`.
---
