---
title: "ReMAPP SAP AIM 1"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    latex_engine: xelatex
    keep_tex: true
header-includes:
  - \usepackage{sectsty}
  - \allsectionsfont{\color{cyan!68!blue}}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%") 
knitr::opts_chunk$set(out.width = "100%", fig.align = "center")

library(tidyverse)
library(naniar)
library(flextable)
library(officer)

load("derived_data/df_baseline.rda")
load("derived_data/df_hb_long.rda")
load("derived_data/df_hb_wide.rda")

#test table format 1
#pvalue format
p_val_format <- function(x){
  z <- scales::pvalue_format()(x)
  z[!is.finite(x)] <- ""
  z
}
#table format
tb_flextable <- function(data, caption, seq_id, bkm) { 
  tb <- qflextable(data)
  tb <- set_table_properties(
    tb, width = 0.8, layout = "autofit",
    opts_pdf = list(tabcolsep = 3)) 
  tb <- set_caption(tb,
    caption = as_paragraph(
as_chunk(caption, props = fp_text_default(font.family = "Cambria"))
),
    word_stylename = "Table Caption",
    autonum = run_autonum(seq_id = seq_id, bkm = bkm)
  )
  tb <- bold(tb, bold = FALSE, part = "header")
  tb <- set_formatter(tb, values = list(
    "p.value" = p_val_format))
  tb
}

```


### Includes data from synapse last updated: {.unlisted .unnumbered}

### Pakistan : 2023-06-09 {.unlisted .unnumbered}
### Kenya : 2023-06-02 {.unlisted .unnumbered}
### Ghana : 2023-06-09 {.unlisted .unnumbered}

\newpage
# **Data overview**

## Data description

All enrolled participants in PRiSMA study are currently included in the analysis, temporarily for the purpose of testing the code, due to lack of data in healthy cohort. 

## Data cleaning

- Long-format data:
    - Remove rows that have missing values on gestational weeks or hemoglobin. 
    - Remove rows that have gestational weeks less than 10 or greater than 50 (42-week pregnancy - 8-week postpartum).
    - Remove rows that have hemoglobin less than 5 or greater than 18.

## Data visualization

We will first run scatter plot and histograms to visualize the hemoglobin data across gestational age and sites.

###  Hemoglobin by gestational age by site

```{r scatter plot} 
#plot hb vs ga_wks
df_hb_long %>% 
  ggplot(aes(x = ga_wks, y = hb, color = "CBC-HB")) + 
  geom_point(alpha = 0.3) +
  facet_wrap(vars(SITE), nrow=2) +
  xlab("Gestational Age (weeks)") +
  ylab("Hemoglobin (g/dL)") +
  xlim(10,50) +
  scale_color_discrete(name = "Hemoglobin Measure")+
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(strip.background=element_rect(fill="white")) 

```

We can visualize the relationship between gestational age and hemoglobin values from the plot. 

### Hemoglobin by trimester by site

```{r histogram, out.height = '100%'}
df_hb_long %>% 
  mutate(
    TRIMES = case_when(
      ga_wks > 3 & ga_wks < 14 ~ "Trimester 1",
      ga_wks >= 14 & ga_wks < 27 ~ "Trimester 2",
      ga_wks >= 27 & ga_wks < 43 ~ "Trimester 3",
      TRUE ~ NA_character_,
    )) %>% 
  filter(!is.na(TRIMES)) %>%
  ggplot(aes(x = hb)) +
  geom_histogram(fill = "#56B4E9", color = "black", 
                 alpha=0.5, position="identity", binwidth = 0.5) +
  scale_x_continuous(breaks=seq(5,18,1))+
  xlab("Hemoglobin (g/dL)") +
  ylab("Frequency Count")+
  facet_wrap(vars(SITE, TRIMES), scales="free_y", drop = FALSE) + 
  theme_bw() +
  theme(strip.background=element_rect(fill="white")) 
  
```

- Trimester1: 0-13 weeks; Trimester2: 14-26 weeks; Trimester3: 27-40 weeks.

We can also visualize the distribution of hemoglobin values within each trimester by site.

# **Test data**

In the section, we will test the normality of hemoglobin distribution and use either linear hemoglobin (if data roughly normal) or ln(hemoglobin) (if skewed) as the outcome in the Analysis of Variance (ANOVA). 

## Visualizing normality by site

```{r, out.width='80%'}
df_hb_long %>% 
  ggplot(aes(x = hb)) +
  geom_histogram(aes(y=..density..),
    fill = "lightgrey", color = "black",lwd=0.5,
    alpha=0.5, position="identity", binwidth = 0.5) +
  geom_density(lwd=0.6, colour="turquoise3", fill="turquoise1", alpha=0.16) +
  scale_x_continuous(breaks=seq(4,16,1))+
  xlab("Hemoglobin (g/dL)") +
  ylab("Density")+
  facet_grid(rows = vars(SITE), scales="free_y") +
  theme_bw() +
  theme(strip.background=element_rect(fill="white")) 

``` 
The density plot will show us if the distribution is bell shaped.

## Testing normality by site

```{r Shapiro-Wilk test}
test_hb_normal <- df_hb_long %>%
  group_by(SITE) %>%
  summarise(statistic = shapiro.test(hb)$statistic,
            p.value = shapiro.test(hb)$p.value)
# print table
tb_flextable(test_hb_normal, "Test of Normality of Hemoglobin by Site",
             seq_id = "tb", bkm = "tb1")

```

P value < 0.05 will indicate that the data is not normally distributed. 


## Test hemoglobin heterogeneity across sites

Heterogeneity in CBC-hemoglobin across sites is first assessed by comparing the percentages of the variance due to inter-subject and inter-site differences estimated by analysis-of-variance techniques. Variance component analysis is based on a liner mixed-effect model, with gestational age treated as fixed effect, and sites and individuals treated as random effects. We will test the significance of site effect in the model. 

```{r lme, message=FALSE, warning=FALSE, out.width='80%'}
# call package lme4 to fit linear mixed effects model
library(lme4)
library(lmerTest)
# fit linear mixed effects model
# use site and subject as random effects
df_hb_long <- df_hb_long %>% 
  mutate(sites = as.factor(SITE))

lme_mod <- lmer(hb ~ ga_wks + (1 | sites) + (1 | sites:MOMID), data = df_hb_long, REML = TRUE)

# obtain variance components
hb_var <- VarCorr(lme_mod) %>% as.data.frame()
# calculate the variance proportion
hb_var_prop <- data.frame(
  "Variance component" = c("Var(subject within site)", "Var(site)", "Var(error)"),
  
  Estimates = hb_var$vcov,
  
  "Standard error" = hb_var$sdcor,
  
  check.names = FALSE
) %>%
  
  mutate("Proportion(%)" = Estimates / sum(Estimates) * 100) %>%
  
  mutate(across(c(2:4), ~ round(.x, 3)))

# print table
tb_flextable(hb_var_prop, "Variance component analysis on linear mixed-effects model", 
             seq_id = "tb", bkm = "tb1") 
```

We will compare the percentage of variance due to inter-site and that of inter-individual. 

```{r site effect}
# test site effect
test_site_effect <- ranova(lme_mod) %>% 
  as.data.frame() %>% 
  add_column(c("", "SITE", "SITE:MOMID"), .before = 1) %>%
  
  rename_with(~ c("Term", "npar", "loglik", "AIC", "LRT", "Df", "p.value"), c(1:7))
# print table
tb_flextable(test_site_effect, "Test the Effect of Site",
             seq_id = "tb", bkm = "tb1")
```
We will also check the the significance of site effect. P value < 0.05 will indicates that the site effect cannot be ignored, so the data shouldn't be pooled. 

# **Centile plots of hemoglobin against gestational weeks - Pooled**

Assuming we have normally distributed data and the heterogeneity of CBC-hemoglobin across sites can be ignored,  we pool the CBC-hemoglobin from all sites together, and estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles of hemoglobin at given gestational weeks during pregnancy and 6-week postpartum.

```{r}
# use long format data
df_fpr <- df_hb_long %>% 
dplyr :: select(SITE, ga_wks, hb, preterm) %>% 
  filter(!is.na(hb), !is.na(ga_wks)) 

```

## Fractional polynomial regression

By assuming that the hemoglobin follows a normal distribution $N(\mu(t), \sigma^2(t))$ at given gestational week $(t)$, the fractional polynomial regression (FPR) model fits regression models for both the mean parameter $\mu$ and standard deviation parameter $\sigma$. Then estimate the centiles by using the equation
$$C_{100\alpha}(t) = \mu(t) + Z_{\alpha}\sigma(t)$$,
where $C_{100\alpha}(t)$ is the expected hemoglobin centile $100\alpha$ at given gestational week $(t)$, and $Z_{\alpha}$ is the normal equivalent deviate of size $\alpha$.

```{r}
# call package gamlss to fit FPR model
library(gamlss)

# fit a second-order FPR model
con <- gamlss.control(trace = FALSE)

fpr_mod <- gamlss(
  hb ~ fp(ga_wks, 2),
  
  sigma.fo = ~ fp(ga_wks, 2),
  
  data = df_fpr, control = con
)
```


```{r}
# get model coefficients for mean and sigma
tb_coef <- rbind(
  
  getSmo(fpr_mod, what = "mu")$coef,
  
  getSmo(fpr_mod, what = "sigma")$coef
  
) %>%
  
  as.data.frame() %>%
  
  #add parameter column mu and sigma
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>% 
  
  rename_with(~ c("parameter", "intercept", "coefficient 1", "coefficient 2"), c(1:4)) 

  tb_flextable(tb_coef, "FPR coefficients for \U03BC and \U03C3", seq_id = "tb", bkm = "tb4") 
```


```{r}
# get model polynomial powers for mean and sigma
tb_power <- rbind(
  
  getSmo(fpr_mod, what = "mu")$power,
  
  getSmo(fpr_mod, what = "sigma")$power
  
) %>%
  
  as.data.frame() %>%
  
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>%
  
  rename_with(~ c("parameter", "power 1", "power 2"), c(1:3))
# print table
tb_flextable(tb_power, "FPR powers for \U03BC and \U03C3", seq_id = "tb", bkm = "tb5")

```

<!-- The FPR model for $\mu$ and $\sigma$ are -->
<!-- $$\mu = 3.9232198 - 3.2330702(GA) + 0.5877617(GA)^{2}$$ -->
<!-- and $$\sigma = -0.1723504 + 0.2009709(GA)^{-2} + 0.7699713(GA)^{-2}log(GA)$$ -->
<!-- respectively. -->

<!-- Given the fitted FPR model, we can plot the centile curves of hemoglobin against the gestational weeks. Also add the WHO thresholds to compare with. -->

## Centile curves using FPR model (2.5, 5, 10, 50, 90, 95, 97.5)th centiles vs WHO threshold
```{r, results='hide'}
#check minimum GA
minGa <- min(df_fpr$ga_wks, na.rm = TRUE) 
minGa
minGaDays <- (minGa-floor(minGa))*7
minGaDays

```

```{r centile plot pooled,  results='hide'}
# make centile plots based on the fitted FPR model
par(mar=c(4, 4, 4, 3), 
    xpd=TRUE, 
    cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod, 
  xvar = df_fpr$ga_wks, 
  cent = c(2.5, 5, 10, 50, 90, 95, 97.5),
  legend = FALSE, 
  xlab = "Gestational Age (weeks)", ylab = "CBC Hb (g/dL)", 
  main = "Centile Curves Using FPR Model \n (2.5, 5, 10, 50, 90, 95, 97.5)th Centiles vs WHO Threshold \n Pooled", 
  bg = "transparent", 
  xlim = range(10,50), 
  pch = 15, 
  cex = 0.3,
  col = "lightgrey",
  col.cent = c("red", "blue", "purple", "green", "purple", "blue", "red"),
  )
segments(x0 = min(df_fpr$ga_wks), y0 = 11, x1 = 14, y1 = 11, col="black", lty = 2)
segments(x0 = 14, y0 = 10.5, x1 = 27, y1 = 10.5, col="black", lty = 2)
segments(x0 = 27, y0 = 11, x1 = 42, y1 = 11, col="black", lty = 2)
text(x = 10.5, y = 11.5, "11", col = "black", cex = 0.66)
text(x = 20.5, y = 11, "10.5", col = "black", cex = 0.66)
text(x = 34.5, y = 11.5, "11", col = "black", cex = 0.66)

legend("topright", inset = c(0,0),
       legend = c(2.5, 5, 10, 50, 90, 95, 97.5, "WHO"), 
       cex = 0.6,
       col = c("red", "blue", "purple", "green", "purple", "blue", "red", "black"),
       lty = c(1,1,1,1,1,1,1,2)) 

```


## Diagnostic plot
We use diagnostic plots to examine if the FPR model is a good fit to the hemoglobin centile curves.


```{r, results='hide'}
df_empi_cent <- df_fpr %>% 
  mutate(ga_wks_floor = floor(ga_wks)) %>% 
  group_by(ga_wks_floor) %>% 
  summarise(cent_2.5 = quantile(hb, probs = c(0.025), na.rm = TRUE),
            cent_50 = quantile(hb, probs = c(0.50), na.rm = TRUE),
            cent_97.5 = quantile(hb, probs = c(0.975), na.rm = TRUE)) %>% 
  ungroup()
```

```{r, results='hide'}
#change font size
par(cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod,
  xvar = df_fpr$ga_wks, cent = c(2.5, 50, 97.5),
  xlab = "Gestational age (weeks)", ylab = "Hemoglobin (g/dL)",
  main = "FPR centiles VS Empirical centiles\n2.5th, 50th, 97.5th centiles \n Pooled",
  points = FALSE,
  bg = "transparent", legend = FALSE,
  col.cent = rep("black", 7)
  )

points(x = df_empi_cent$ga_wks_floor, y = df_empi_cent$cent_2.5, col = "red")
points(x = df_empi_cent$ga_wks_floor, y = df_empi_cent$cent_50, col = "blue")
points(x = df_empi_cent$ga_wks_floor, y = df_empi_cent$cent_97.5, col = "red")
```
In the “FPR centiles VS Empirical centiles” plot, we will observe if the FPR curves are consistent with empirical curves.

In addition, we use four plots of normalized quantile residuals to check the adequacy of the fitted fractional polynomial regression model. If the residuals display the behavior of following a standard normal distribution, the model is a good fit. The four plots are:

- top left: residuals against the fitted values of the mean parameter.

- top right: residuals against the specified covariate.

- bottom left: a kernel density estimate of the residuals.

- bottom right: a QQ-normal plot of the residuals.


```{r}
newpar <- par(mfrow = c(2, 2), mar = par("mar") + c(0, 1, 0, 0), #margin

              col.axis = "blue4", col = "blue4", col.main = "blue4",

              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 1.2,

              cex.axis = 1, cex.main = 1.2)

plot(fpr_mod, xvar = df_fpr$ga_wks, par = newpar, summaries = FALSE)

par(newpar)

```
The residuals behave well if the top two plots show a random scatter around the horizontal line at 0, and the kernel density estimate of the residuals is approximately normal and the normal QQ-plot is approximately linear. 

## Estimate the centiles at given gestational weeks

We estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles at 14, 28, 40 gestational weeks using predictions from the FPR curves. We need discuss at which GA weeks the hemoglobin value need to be predicted.

```{r, results='hide'}
# centiles at 14, 28, 40 gestational weeks predicted by FPR model

tb_cent <- centiles.pred(fpr_mod,

  xname = "ga_wks", xvalues = c(14, 28, 40),

  type = c("centiles"), cent = c(2.5, 5, 10, 50, 90, 95, 97.5)

) %>% as.data.frame() %>% 

  round(3) %>% 

  rename_with(~ c("gestational week", paste0(c(2.5, 5, 10, 50, 90, 95, 97.5), "th")))

# print table
``` 

```{r FPR predicted centiles}
tb_flextable(tb_cent, "FPR predicted centiles", seq_id = "tb", bkm = "tb6")
```

## Sensitivity analysis

### Sensitivity analysis by excluding the subgroup of subjects with adverse oucomes. 

Compare sample under each subsample \textcolor{red}{(red line)} with all enrolled (black line).
We need discuss more subgroups.

- Sensitivity analysis by excluding the subgroup of subjects with preterm delivery

```{r , results='hide', fig.align='center', out.width='60%'} 
#fig.show="hold", 
# centiles
cents <- c(2.5, 50, 97.5)

# a function to plot centile curves after excluding certain site
fpr_mod_sensitive <- function(s){
  # remove the selected site data
  dat <- df_fpr %>% filter(eval(parse(text = paste0(s,"!= 1"))))
  # fit a FPR model on the rest data
  mod <- gamlss(hb ~ fp(ga_wks, 2),
                sigma.fo = ~ fp(ga_wks, 2),
                data = dat, control = con)

  x <- df_fpr$ga_wks
  # predict hemoglobin centiles by FPR model fitted on all data
  y_fpr_mod <- centiles.pred(fpr_mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = df_fpr)
  # predict hemoglobin centiles by FPR model fitted on all data excluding the site
  y_mod <- centiles.pred(mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = dat)

  # compare the centile curves
  plot(y_fpr_mod[,1], y_fpr_mod[,2],
       
       ylim = c(5, 18),
       
       type="n",
       
       xlab = "Gestational week", ylab = "Hemoglobin (g/dL)",
       
       main = paste0("Excluding ", s))
  
  for(i in 2:(length(cents)+1)) {
    lines(y_fpr_mod[,1], y_fpr_mod[,i], col = "black", lty = "longdash")
    lines(y_mod[,1], y_mod[,i], col = "red")
  }
}


newpar <- par(mfrow = c(1,1), mar = par("mar") + c(0, 1, 0, 0),
              col.axis = "blue4", col = "blue4", col.main = "blue4",
              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 2,
              cex.axis = 2, cex.main = 2)
# remove preterm
fpr_mod_sensitive("preterm")
par(newpar)
```
Check if the centile plots overlaps by removing the group with preterm delivery. 

### Sensitivity analysis by excluding one site at a time

```{r , fig.show="hold", results='hide'}
# sites id
sites <- as.character(c(1:4))
# centiles
cents <- c(2.5, 50, 97.5)

# a function to plot centile curves after excluding certain site
fpr_mod_site <- function(s){
  
  # remove the selected site data
  dat <- df_fpr %>% filter(SITE != s)
  # fit a FPR model on the rest data
  mod <- gamlss(hb ~ fp(ga_wks, 2),
                sigma.fo = ~ fp(ga_wks, 2),
                data = dat, control = con)

  x <- df_fpr$ga_wks
  # predict hemoglobin centiles by FPR model fitted on all data
  y_fpr_mod <- centiles.pred(fpr_mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = df_fpr)
  # predict hemoglobin centiles by FPR model fitted on all data excluding the site
  y_mod <- centiles.pred(mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = dat)

  # compare the centile curves
  plot(y_fpr_mod[,1], y_fpr_mod[,2],
       
       ylim = c(5, 18),
       
       type="n",
       
       xlab = "Gestational week", ylab = "Hemoglobin (g/dL)",
       
       main = paste0("Excluding ", s))
  
  for(i in 2:(length(cents)+1)) {
    lines(y_fpr_mod[,1], y_fpr_mod[,i], col = "black", lty = "longdash")
    lines(y_mod[,1], y_mod[,i], col = "red")
  }
}


newpar <- par(mfrow = c(2, 2), mar = par("mar") + c(0, 1, 0, 0),
              col.axis = "blue4", col = "blue4", col.main = "blue4",
              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 1.2,
              cex.axis = 1, cex.main = 1.2)
# remove site 1
fpr_mod_site("Pakistan")
# remove site 2
fpr_mod_site("Kenya")
# remove site 3
fpr_mod_site("Ghana")
# remove site 4
# fpr_mod_site("4")
par(newpar)
```
Check if the centile plots overlaps by removing one site at a time. 

# **Centile plots of hemoglobin against gestational weeks - Pakistan**

Assuming we have normally distributed data and the heterogeneity of CBC-hemoglobin across sites cannot be ignored, we will do site specific analysis. We will use Pakistan data in this section and estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles of hemoglobin at given gestational weeks during pregnancy and 6-week postpartum.


```{r}
# use long format data
df_fpr_pa <- df_hb_long %>% 
  filter(SITE == "Pakistan") %>% 
dplyr :: select(SITE, ga_wks, hb, preterm) %>% 
  filter(!is.na(hb), !is.na(ga_wks)) 

```

## Fractional polynomial regression

By assuming that the hemoglobin follows a normal distribution $N(\mu(t), \sigma^2(t))$ at given gestational week $(t)$, the fractional polynomial regression (FPR) model fits regression models for both the mean parameter $\mu$ and standard deviation parameter $\sigma$. Then estimate the centiles by using the equation
$$C_{100\alpha}(t) = \mu(t) + Z_{\alpha}\sigma(t)$$,
where $C_{100\alpha}(t)$ is the expected hemoglobin centile $100\alpha$ at given gestational week $(t)$, and $Z_{\alpha}$ is the normal equivalent deviate of size $\alpha$.

```{r}
# call package gamlss to fit FPR model
library(gamlss)

# fit a second-order FPR model
con <- gamlss.control(trace = FALSE)

fpr_mod_pa <- gamlss(
  hb ~ fp(ga_wks, 2),
  
  sigma.fo = ~ fp(ga_wks, 2),
  
  data = df_fpr_pa, control = con
)
```


```{r}
# get model coefficients for mean and sigma
tb_coef_pa <- rbind(
  
  # getSmo(fpr_mod_pa, what = "mu")$coef,
  # 
  # getSmo(fpr_mod_pa, what = "sigma")$coef
  
  getSmo(fpr_mod_pa, what = "mu", which=1)$coef,
getSmo(fpr_mod_pa, what = "sigma", which=1)$coef
  
) %>%
  
  as.data.frame() %>%
  
  #add parameter column mu and sigma
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>% 
  
  rename_with(~ c("parameter", "intercept", "coefficient 1", "coefficient 2"), c(1:4)) 

  tb_flextable(tb_coef_pa, "FPR coefficients for \U03BC and \U03C3", seq_id = "tb", bkm = "tb4") 
```


```{r}
# get model polynomial powers for mean and sigma
tb_power_pa <- rbind(
  
  getSmo(fpr_mod_pa, what = "mu")$power,
  
  getSmo(fpr_mod_pa, what = "sigma")$power
  
) %>%
  
  as.data.frame() %>%
  
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>%
  
  rename_with(~ c("parameter", "power 1", "power 2"), c(1:3))
# print table
tb_flextable(tb_power_pa, "FPR powers for \U03BC and \U03C3", seq_id = "tb", bkm = "tb5")

```

<!-- The FPR model for $\mu$ and $\sigma$ are -->
<!-- $$\mu = 4.0551844 - 3.3758675(GA) + 0.6284372(GA)^{2}$$ -->
<!-- and $$\sigma = -0.1534883 + 0.1729546(GA)^{-2} + 0.7328640(GA)^{-2}log(GA)$$ -->
<!-- respectively. -->

<!-- Given the fitted FPR model, we can plot the centile curves of hemoglobin against the gestational weeks. Also add the WHO thresholds to compare with. -->

## Centile curves using FPR model (2.5, 5, 10, 50, 90, 95, 97.5)th centiles vs WHO threshold

```{r centile plot Pakistan,  results='hide'}
# make centile plots based on the fitted FPR model
par(mar=c(4, 4, 4, 3), 
    xpd=TRUE, 
    cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod_pa, 
         
  xvar = df_fpr_pa$ga_wks, 
  
  cent = c(2.5, 5, 10, 50, 90, 95, 97.5),
  
  legend = FALSE, 
  
  xlab = "Gestational Age (weeks)", ylab = "CBC Hb (g/dL)",
  
  main = "Centile Curves Using FPR Model \n (2.5, 5, 10, 50, 90, 95, 97.5)th Centiles vs WHO Threshold \n Pakistan", 
  
  bg = "transparent", 
  
  xlim = range(10,50), 
  
  pch = 15, 
  
  cex = 0.3, 
  
  col = "lightgrey",
  
  col.cent = c("red", "blue", "purple", "green", "purple", "blue", "red"),
  )

segments(x0 = min(df_fpr_pa$ga_wks), y0 = 11, x1 = 14, y1 = 11, col="black", lty = 2)

segments(x0 = 14, y0 = 10.5, x1 = 27, y1 = 10.5, col="black", lty = 2)

segments(x0 = 27, y0 = 11, x1 = 42, y1 = 11, col="black", lty = 2)

text(x = 10.5, y = 11.5, "11", col = "black", cex = 0.66)

text(x = 20.5, y = 11, "10.5", col = "black", cex = 0.66)

text(x = 34.5, y = 11.5, "11", col = "black", cex = 0.66)

legend("topright", inset = c(0,0),
       
       legend = c(2.5, 5, 10, 50, 90, 95, 97.5, "WHO"), 
       
       cex = 0.6,
       
       col = c("red", "blue", "purple", "green", "purple", "blue", "red", "black"),
       
       lty = c(1,1,1,1,1,1,1,2)) 


```


## Diagnostic plot
We use diagnostic plots to examine if the FPR model is a good fit to the hemoglobin centile curves.

```{r, results='hide'}
df_empi_cent_pa <- df_fpr_pa %>% 
  
  mutate(ga_wks_floor = floor(ga_wks)) %>% 

  group_by(ga_wks_floor) %>% 

  summarise(cent_2.5 = quantile(hb, probs = c(0.025), na.rm = TRUE),

            cent_50 = quantile(hb, probs = c(0.50), na.rm = TRUE),

            cent_97.5 = quantile(hb, probs = c(0.975), na.rm = TRUE)) %>% 

  ungroup()
```

```{r, results='hide'}
#change font size
par(cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod_pa,

  xvar = df_fpr_pa$ga_wks, cent = c(2.5, 50, 97.5),

  xlab = "Gestational age (weeks)", ylab = "Hemoglobin (g/dL)",

  main = "FPR centiles VS Empirical centiles\n2.5th, 50th, 97.5th centiles \n Pakistan",

  points = FALSE,

  bg = "transparent", legend = FALSE,

  col.cent = rep("black", 7)

  )

points(x = df_empi_cent_pa$ga_wks_floor, y = df_empi_cent_pa$cent_2.5, col = "red")

points(x = df_empi_cent_pa$ga_wks_floor, y = df_empi_cent_pa$cent_50, col = "blue")

points(x = df_empi_cent_pa$ga_wks_floor, y = df_empi_cent_pa$cent_97.5, col = "red")
```

In the “FPR centiles VS Empirical centiles” plot, we will observe if the FPR curves are consistent with empirical curves.

In addition, we use four plots of normalized quantile residuals to check the adequacy of the fitted fractional polynomial regression model. If the residuals display the behavior of following a standard normal distribution, the model is a good fit. The four plots are:

- top left: residuals against the fitted values of the mean parameter.

- top right: residuals against the specified covariate.

- bottom left: a kernel density estimate of the residuals.

- bottom right: a QQ-normal plot of the residuals.

```{r}
newpar <- par(mfrow = c(2, 2), mar = par("mar") + c(0, 1, 0, 0), #margin

              col.axis = "blue4", col = "blue4", col.main = "blue4",

              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 1.2,

              cex.axis = 1, cex.main = 1.2)

plot(fpr_mod_pa, xvar = df_fpr_pa$ga_wks, par = newpar, summaries = FALSE)

par(newpar)

```

The residuals behave well if the top two plots show a random scatter around the horizontal line at 0, and the kernel density estimate of the residuals is approximately normal and the normal QQ-plot is approximately linear.

## Estimate the centiles at given gestational weeks

We estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles at 14, 28, 40 gestational weeks using predictions from the FPR curves. We need discuss at which GA weeks the hemoglobin value need to be predicted.

```{r, results='hide'}
# centiles at 14, 28, 40 gestational weeks predicted by FPR model

tb_cent_pa <- centiles.pred(fpr_mod_pa,

  xname = "ga_wks", xvalues = c(14, 28, 40), #xvalues = seq(10, 40, 1)

  type = c("centiles"), cent = c(2.5, 5, 10, 50, 90, 95, 97.5)

) %>% as.data.frame() %>% 

  round(3) %>% 

  rename_with(~ c("gestational week", paste0(c(2.5, 5, 10, 50, 90, 95, 97.5), "th")))

# print table
``` 

```{r FPR predicted centiles-Pakistan}
tb_flextable(tb_cent_pa, "FPR predicted centiles - Pakistan", seq_id = "tb", bkm = "tb6")
```

## Sensitivity analysis

### Sensitivity analysis by excluding the subgroup of subjects with adverse oucomes. 

Compare sample under each subsample \textcolor{red}{(red line)} with all enrolled (black line).

- Sensitivity analysis by excluding the subgroup of subjects with preterm delivery

```{r , results='hide', fig.align='center', out.width='60%'} 
#fig.show="hold", 
# centiles
cents <- c(2.5, 50, 97.5)

# a function to plot centile curves after excluding certain site
fpr_mod_sensitive_pa <- function(s){
  
  # remove the selected site data
  dat <- df_fpr_pa %>% filter(eval(parse(text = paste0(s,"!= 1"))))
  # fit a FPR model on the rest data
  mod <- gamlss(hb ~ fp(ga_wks, 2),
                sigma.fo = ~ fp(ga_wks, 2),
                data = dat, control = con)

  x <- df_fpr_pa$ga_wks
  # predict hemoglobin centiles by FPR model fitted on all data
  y_fpr_mod <- centiles.pred(fpr_mod_pa,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = df_fpr_pa)
  # predict hemoglobin centiles by FPR model fitted on all data excluding the site
  y_mod <- centiles.pred(mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = dat)

  # compare the centile curves
  plot(y_fpr_mod[,1], y_fpr_mod[,2],
       
       ylim = c(5, 18),
       
       type="n",
       
       xlab = "Gestational week", ylab = "Hemoglobin (g/dL)",
       
       main = paste0("Excluding ", s))
  
  for(i in 2:(length(cents)+1)) {
    lines(y_fpr_mod[,1], y_fpr_mod[,i], col = "black", lty = "longdash")
    lines(y_mod[,1], y_mod[,i], col = "red")
  }
}


newpar <- par(mfrow = c(1,1), mar = par("mar") + c(0, 1, 0, 0),
              col.axis = "blue4", col = "blue4", col.main = "blue4",
              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 2,
              cex.axis = 2, cex.main = 2)
# remove preterm
fpr_mod_sensitive_pa("preterm")
par(newpar)
```

Check if the centile plots overlaps by removing the group with preterm delivery. 

# **Centile plots of hemoglobin against gestational weeks - Kenya**

Assuming we have normally distributed data and the heterogeneity of CBC-hemoglobin across sites cannot be ignored, we will do site specific analysis. We will use Kenya data in this section and estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles of hemoglobin at given gestational weeks during pregnancy and 6-week postpartum.


```{r}
# use long format data
df_fpr_ke <- df_hb_long %>% 
  filter(SITE == "Kenya") %>% 
dplyr :: select(SITE, ga_wks, hb, preterm) %>% 
  filter(!is.na(hb), !is.na(ga_wks)) 

```

## Fractional polynomial regression

By assuming that the hemoglobin follows a normal distribution $N(\mu(t), \sigma^2(t))$ at given gestational week $(t)$, the fractional polynomial regression (FPR) model fits regression models for both the mean parameter $\mu$ and standard deviation parameter $\sigma$. Then estimate the centiles by using the equation
$$C_{100\alpha}(t) = \mu(t) + Z_{\alpha}\sigma(t)$$,
where $C_{100\alpha}(t)$ is the expected hemoglobin centile $100\alpha$ at given gestational week $(t)$, and $Z_{\alpha}$ is the normal equivalent deviate of size $\alpha$.

```{r}
# call package gamlss to fit FPR model
library(gamlss)

# fit a second-order FPR model
con <- gamlss.control(trace = FALSE)

fpr_mod_ke <- gamlss(
  hb ~ fp(ga_wks, 2),
  
  sigma.fo = ~ fp(ga_wks, 2),
  
  data = df_fpr_ke, control = con
)
```


```{r}
# get model coefficients for mean and sigma
tb_coef_ke <- rbind(
  
  getSmo(fpr_mod_ke, what = "mu")$coef,
  
  getSmo(fpr_mod_ke, what = "sigma")$coef
  
) %>%
  
  as.data.frame() %>%
  
  #add parameter column mu and sigma
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>% 
  
  rename_with(~ c("parameter", "intercept", "coefficient 1", "coefficient 2"), c(1:4)) 

  tb_flextable(tb_coef_ke, "FPR coefficients for \U03BC and \U03C3", seq_id = "tb", bkm = "tb4") 
```


```{r}
# get model polynomial powers for mean and sigma
tb_power_ke <- rbind(
  
  getSmo(fpr_mod_ke, what = "mu")$power,
  
  getSmo(fpr_mod_ke, what = "sigma")$power
  
) %>%
  
  as.data.frame() %>%
  
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>%
  
  rename_with(~ c("parameter", "power 1", "power 2"), c(1:3))
# print table
tb_flextable(tb_power_ke, "FPR powers for \U03BC and \U03C3", seq_id = "tb", bkm = "tb5")

```

<!-- The FPR model for $\mu$ and $\sigma$ are -->
<!-- $$\mu = -0.57239819 + 1.17953387(GA)^{-1} - 0.04937728(GA)^{3}log(GA)$$ -->
<!-- and $$\sigma = 0.08065477 + 0.06477331(GA)^{-2} - 0.68960504(GA)^{-2}log(GA)$$ -->
<!-- respectively. -->

<!-- Given the fitted FPR model, we can plot the centile curves of hemoglobin against the gestational weeks. Also add the WHO thresholds to compare with. -->

## Centile curves using FPR model (2.5, 5, 10, 50, 90, 95, 97.5)th centiles vs WHO threshold

```{r centile plot Kenya,  results='hide'}
# make centile plots based on the fitted FPR model
par(mar=c(4, 4, 4, 3), 
    xpd=TRUE, 
    cex.main = 0.85, 
    cex.lab = 0.8,
    cex.axis = 0.8)

centiles(fpr_mod_ke, 
         
  xvar = df_fpr_ke$ga_wks, 
  
  cent = c(2.5, 5, 10, 50, 90, 95, 97.5),
  
  legend = FALSE, 
  
  xlab = "Gestational Age (weeks)", ylab = "CBC Hb (g/dL)", 
  
  main = "Centile Curves Using FPR Model \n (2.5, 5, 10, 50, 90, 95, 97.5)th Centiles vs WHO Threshold \n Kenya", 
  
  bg = "transparent", 
  
  xlim = range(10,50), 
  
  pch = 15,
  
  cex = 0.3, 
  
  col = "lightgrey",
  
  col.cent = c("red", "blue", "purple", "green", "purple", "blue", "red"),
  )


segments(x0 = min(df_fpr_ke$ga_wks), y0 = 11, x1 = 14, y1 = 11, col="black", lty = 2)

segments(x0 = 14, y0 = 10.5, x1 = 27, y1 = 10.5, col="black", lty = 2)

segments(x0 = 27, y0 = 11, x1 = 42, y1 = 11, col="black", lty = 2)

text(x = 10.5, y = 11.5, "11", col = "black", cex = 0.66)

text(x = 20.5, y = 11, "10.5", col = "black", cex = 0.66)

text(x = 34.5, y = 11.5, "11", col = "black", cex = 0.66)

legend("topright", inset = c(0,0),
       
       legend = c(2.5, 5, 10, 50, 90, 95, 97.5, "WHO"), 
       
       cex = 0.6,
       
       col = c("red", "blue", "purple", "green", "purple", "blue", "red", "black"),
       
       lty = c(1,1,1,1,1,1,1,2)) 


```


## Diagnostic plot
We use diagnostic plots to examine if the FPR model is a good fit to the hemoglobin centile curves.


```{r, results='hide'}
df_empi_cent_ke <- df_fpr_ke %>% 
  
  mutate(ga_wks_floor = floor(ga_wks)) %>% 

  group_by(ga_wks_floor) %>% 

  summarise(cent_2.5 = quantile(hb, probs = c(0.025), na.rm = TRUE),

            cent_50 = quantile(hb, probs = c(0.50), na.rm = TRUE),

            cent_97.5 = quantile(hb, probs = c(0.975), na.rm = TRUE)) %>% 

  ungroup()
```

```{r, results='hide'}
#change font size
par(cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod_ke,

  xvar = df_fpr_ke$ga_wks, cent = c(2.5, 50, 97.5),

  xlab = "Gestational age (weeks)", ylab = "Hemoglobin (g/dL)",

  main = "FPR centiles VS Empirical centiles\n2.5th, 50th, 97.5th centiles \nKenya",
  points = FALSE,

  bg = "transparent", legend = FALSE,

  col.cent = rep("black", 7)

  )

points(x = df_empi_cent_ke$ga_wks_floor, y = df_empi_cent_ke$cent_2.5, col = "red")

points(x = df_empi_cent_ke$ga_wks_floor, y = df_empi_cent_ke$cent_50, col = "blue")

points(x = df_empi_cent_ke$ga_wks_floor, y = df_empi_cent_ke$cent_97.5, col = "red")
```

In the “FPR centiles VS Empirical centiles” plot, we will observe if the FPR curves are consistent with empirical curves.

In addition, we use four plots of normalized quantile residuals to check the adequacy of the fitted fractional polynomial regression model. If the residuals display the behavior of following a standard normal distribution, the model is a good fit. The four plots are:

- top left: residuals against the fitted values of the mean parameter.

- top right: residuals against the specified covariate.

- bottom left: a kernel density estimate of the residuals.

- bottom right: a QQ-normal plot of the residuals.

```{r}
newpar <- par(mfrow = c(2, 2), mar = par("mar") + c(0, 1, 0, 0),

              col.axis = "blue4", col = "blue4", col.main = "blue4",

              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 1.2,

              cex.axis = 1, cex.main = 1.2)

plot(fpr_mod_ke, xvar = df_fpr_ke$ga_wks, par = newpar, summaries = FALSE)

par(newpar)

```

The residuals behave well if the top two plots show a random scatter around the horizontal line at 0, and the kernel density estimate of the residuals is approximately normal and the normal QQ-plot is approximately linear. 

## Estimate the centiles at given gestational weeks

We estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles at 14, 28, 40 gestational weeks using predictions from the FPR curves. We need discuss at which GA weeks the hemoglobin value need to be predicted.

```{r, results='hide'}
# centiles at 14, 28, 40 gestational weeks predicted by FPR model

tb_cent_ke <- centiles.pred(fpr_mod_ke,

  xname = "ga_wks", xvalues = c(14, 28, 40), 

  type = c("centiles"), cent = c(2.5, 5, 10, 50, 90, 95, 97.5)

) %>% as.data.frame() %>% 

  round(3) %>% 

  rename_with(~ c("gestational week", paste0(c(2.5, 5, 10, 50, 90, 95, 97.5), "th")))

# print table
``` 

```{r FPR predicted centiles-Kenya}
tb_flextable(tb_cent_ke, "FPR predicted centiles - Kenya", seq_id = "tb", bkm = "tb6")
```

## Sensitivity analysis

### Sensitivity analysis by excluding the subgroup of subjects with adverse oucomes. 

Compare sample under each subsample \textcolor{red}{(red line)} with all enrolled (black line).


- Sensitivity analysis by excluding the subgroup of subjects with preterm delivery

```{r , results='hide', fig.align='center', out.width='60%'} 
#fig.show="hold", 
# centiles
cents <- c(2.5, 50, 97.5)

# a function to plot centile curves after excluding certain site
fpr_mod_sensitive_ke <- function(s){
  
  # remove the selected site data
  dat <- df_fpr_ke %>% filter(eval(parse(text = paste0(s,"!= 1"))))
  # fit a FPR model on the rest data
  mod <- gamlss(hb ~ fp(ga_wks, 2),
                sigma.fo = ~ fp(ga_wks, 2),
                data = dat, control = con)

  x <- df_fpr_ke$ga_wks
  # predict hemoglobin centiles by FPR model fitted on all data
  y_fpr_mod <- centiles.pred(fpr_mod_ke,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = df_fpr_ke)
  # predict hemoglobin centiles by FPR model fitted on all data excluding the site
  y_mod <- centiles.pred(mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = dat)

  # compare the centile curves
  plot(y_fpr_mod[,1], y_fpr_mod[,2],
       
       ylim = c(5, 18),
       
       type="n",
       
       xlab = "Gestational week", ylab = "Hemoglobin (g/dL)",
       
       main = paste0("Excluding ", s))
  
  for(i in 2:(length(cents)+1)) {
    lines(y_fpr_mod[,1], y_fpr_mod[,i], col = "black", lty = "longdash")
    lines(y_mod[,1], y_mod[,i], col = "red")
  }
}


newpar <- par(mfrow = c(1,1), mar = par("mar") + c(0, 1, 0, 0),
              col.axis = "blue4", col = "blue4", col.main = "blue4",
              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 2,
              cex.axis = 2, cex.main = 2)
# remove preterm
fpr_mod_sensitive_ke("preterm")
# # remove site 2
# fpr_mod_site("Kenya")
# # remove site 3
# fpr_mod_site("Ghana")
# # remove site 4
# # fpr_mod_site("4")
par(newpar)
```

Check if the centile plots overlaps by removing the group with preterm delivery. 

# **Centile plots of hemoglobin against gestational weeks - Ghana**

Assuming we have normally distributed data and the heterogeneity of CBC-hemoglobin across sites cannot be ignored, we will do site specific analysis. We will use Ghana data in this section and estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles of hemoglobin at given gestational weeks during pregnancy and 6-week postpartum.


```{r}
# use long format data
df_fpr_gh <- df_hb_long %>% 
  filter(SITE == "Ghana") %>% 
dplyr :: select(SITE, ga_wks, hb, preterm) %>% 
  filter(!is.na(hb), !is.na(ga_wks)) 

```

## Fractional polynomial regression

By assuming that the hemoglobin follows a normal distribution $N(\mu(t), \sigma^2(t))$ at given gestational week $(t)$, the fractional polynomial regression (FPR) model fits regression models for both the mean parameter $\mu$ and standard deviation parameter $\sigma$. Then estimate the centiles by using the equation
$$C_{100\alpha}(t) = \mu(t) + Z_{\alpha}\sigma(t)$$,
where $C_{100\alpha}(t)$ is the expected hemoglobin centile $100\alpha$ at given gestational week $(t)$, and $Z_{\alpha}$ is the normal equivalent deviate of size $\alpha$.

```{r}
# call package gamlss to fit FPR model
library(gamlss)

# fit a second-order FPR model
con <- gamlss.control(trace = FALSE)

fpr_mod_gh <- gamlss(
  hb ~ fp(ga_wks, 2),
  
  sigma.fo = ~ fp(ga_wks, 2),
  
  data = df_fpr_gh, control = con
)
```


```{r}
# get model coefficients for mean and sigma
tb_coef_gh <- rbind(
  
  getSmo(fpr_mod_gh, what = "mu")$coef,
  
  getSmo(fpr_mod_gh, what = "sigma")$coef
  
) %>%
  
  as.data.frame() %>%
  
  #add parameter column mu and sigma
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>% 
  
  rename_with(~ c("parameter", "intercept", "coefficient 1", "coefficient 2"), c(1:4)) 

  tb_flextable(tb_coef_gh, "FPR coefficients for \U03BC and \U03C3", seq_id = "tb", bkm = "tb4") 
```


```{r}
# get model polynomial powers for mean and sigma
tb_power_gh <- rbind(
  
  getSmo(fpr_mod_gh, what = "mu")$power,
  
  getSmo(fpr_mod_gh, what = "sigma")$power
  
) %>%
  
  as.data.frame() %>%
  
  add_column(c("\U03BC", "\U03C3"), .before = 1) %>%
  
  rename_with(~ c("parameter", "power 1", "power 2"), c(1:3))
# print table
tb_flextable(tb_power_gh, "FPR powers for \U03BC and \U03C3", seq_id = "tb", bkm = "tb5")

```

<!-- The FPR model for $\mu$ and $\sigma$ are -->
<!-- $$\mu = 4.1214023 + 10.90960592(GA)^{-1} - 13.698584(GA)^{-0.5}$$ -->
<!-- and $$\sigma = -0.3991604 - 0.08253146(GA)^{-2} + 2.901297(GA)^{-2}log(GA)$$ -->
<!-- respectively. -->

<!-- Given the fitted FPR model, we can plot the centile curves of hemoglobin against the gestational weeks. Also add the WHO thresholds to compare with. -->

## Centile curves using FPR model (2.5, 5, 10, 50, 90, 95, 97.5)th centiles vs WHO threshold

```{r centile plot Ghana,  results='hide'}
# make centile plots based on the fitted FPR model
par(mar=c(4, 4, 5, 3), 
    xpd=TRUE, 
    cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod_gh, 
         
  xvar = df_fpr_gh$ga_wks, 
  
  cent = c(2.5, 5, 10, 50, 90, 95, 97.5),
  
  legend = FALSE, 
  xlab = "Gestational Age (weeks)", ylab = "CBC Hb (g/dL)",
  
  main = "Centile Curves Using FPR Model \n (2.5, 5, 10, 50, 90, 95, 97.5)th Centiles vs WHO Threshold \n Ghana", 
  sub = "Ghana",
  
  bg = "transparent", 
  
  xlim = range(10,50), 
  
  pch = 15, 
  
  cex = 0.3, 
  
  col = "lightgrey",
  
  col.cent = c("red", "blue", "purple", "green", "purple", "blue", "red"),
  )

segments(x0 = min(df_fpr_gh$ga_wks), y0 = 11, x1 = 14, y1 = 11, col="black", lty = 2)

segments(x0 = 14, y0 = 10.5, x1 = 27, y1 = 10.5, col="black", lty = 2)

segments(x0 = 27, y0 = 11, x1 = 42, y1 = 11, col="black", lty = 2)

text(x = 10.5, y = 11.5, "11", col = "black", cex = 0.66)

text(x = 20.5, y = 11, "10.5", col = "black", cex = 0.66)

text(x = 34.5, y = 11.5, "11", col = "black", cex = 0.66)

legend("topright", inset = c(0,0),
       
       legend = c(2.5, 5, 10, 50, 90, 95, 97.5, "WHO"), 
       
       cex = 0.6,
       
       col = c("red", "blue", "purple", "green", "purple", "blue", "red", "black"),
       
       lty = c(1,1,1,1,1,1,1,2)) 


```


## Diagnostic plot
We use diagnostic plots to examine if the FPR model is a good fit to the hemoglobin centile curves.


```{r, results='hide'}
df_empi_cent_gh <- df_fpr_gh %>% 
  
  mutate(ga_wks_floor = floor(ga_wks)) %>% 

  group_by(ga_wks_floor) %>% 

  summarise(cent_2.5 = quantile(hb, probs = c(0.025), na.rm = TRUE),

            cent_50 = quantile(hb, probs = c(0.50), na.rm = TRUE),

            cent_97.5 = quantile(hb, probs = c(0.975), na.rm = TRUE)) %>% 

  ungroup()
```

```{r, results='hide'}
#change font size
par(cex.main = 0.85, 
    cex.lab = 0.8, 
    cex.axis = 0.8)

centiles(fpr_mod_gh,

  xvar = df_fpr_gh$ga_wks, cent = c(2.5, 50, 97.5),

  xlab = "Gestational age (weeks)", ylab = "Hemoglobin (g/dL)",

  main = "FPR centiles VS Empirical centiles\n2.5th, 50th, 97.5th centiles \n Ghana",
  points = FALSE,

  bg = "transparent", legend = FALSE,

  col.cent = rep("black", 7)

  )

points(x = df_empi_cent_gh$ga_wks_floor, y = df_empi_cent_gh$cent_2.5, col = "red")

points(x = df_empi_cent_gh$ga_wks_floor, y = df_empi_cent_gh$cent_50, col = "blue")

points(x = df_empi_cent_gh$ga_wks_floor, y = df_empi_cent_gh$cent_97.5, col = "red")
```

In the “FPR centiles VS Empirical centiles” plot, we will observe if the FPR curves are consistent with empirical curves.

In addition, we use four plots of normalized quantile residuals to check the adequacy of the fitted fractional polynomial regression model. If the residuals display the behavior of following a standard normal distribution, the model is a good fit. The four plots are:

- top left: residuals against the fitted values of the mean parameter.

- top right: residuals against the specified covariate.

- bottom left: a kernel density estimate of the residuals.

- bottom right: a QQ-normal plot of the residuals.

```{r}
newpar <- par(mfrow = c(2, 2), mar = par("mar") + c(0, 1, 0, 0), 

              col.axis = "blue4", col = "blue4", col.main = "blue4",

              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 1.2,

              cex.axis = 1, cex.main = 1.2)

plot(fpr_mod_gh, xvar = df_fpr_gh$ga_wks, par = newpar, summaries = FALSE)

par(newpar)

```

The residuals behave well if the top two plots show a random scatter around the horizontal line at 0, and the kernel density estimate of the residuals is approximately normal and the normal QQ-plot is approximately linear.

## Estimate the centiles at given gestational weeks

We estimate the 2.5th, 5th, 10th, 50th, 95th and 97.5th centiles at 14, 28, 40 gestational weeks using predictions from the FPR curves. We need discuss at which GA weeks the hemoglobin value need to be predicted.

```{r, results='hide'}
# centiles at 14, 28, 40 gestational weeks predicted by FPR model

tb_cent_gh <- centiles.pred(fpr_mod_gh,

  xname = "ga_wks", xvalues = c(14, 28, 40),

  type = c("centiles"), cent = c(2.5, 5, 10, 50, 90, 95, 97.5)

) %>% as.data.frame() %>% 

  round(3) %>% 

  rename_with(~ c("gestational week", paste0(c(2.5, 5, 10, 50, 90, 95, 97.5), "th")))

``` 

```{r FPR predicted centiles-Ghana}
tb_flextable(tb_cent_gh, "FPR predicted centiles - Ghana", seq_id = "tb", bkm = "tb6")
```

## Sensitivity analysis

### Sensitivity analysis by excluding the subgroup of subjects with adverse oucomes. 

Compare sample under each subsample \textcolor{red}{(red line)} with all enrolled (black line).

- Sensitivity analysis by excluding the subgroup of subjects with preterm delivery

```{r , results='hide', fig.align='center', out.width='60%'} 
# centiles
cents <- c(2.5, 50, 97.5)

# a function to plot centile curves after excluding certain site
fpr_mod_sensitive_gh <- function(s){
  
  # remove the selected site data
  dat <- df_fpr_gh %>% filter(eval(parse(text = paste0(s,"!= 1"))))
  # fit a FPR model on the rest data
  mod <- gamlss(hb ~ fp(ga_wks, 2),
                sigma.fo = ~ fp(ga_wks, 2),
                data = dat, control = con)

  x <- df_fpr_gh$ga_wks
  # predict hemoglobin centiles by FPR model fitted on all data
  y_fpr_mod <- centiles.pred(fpr_mod_gh,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = df_fpr_gh)
  # predict hemoglobin centiles by FPR model fitted on all data excluding the site
  y_mod <- centiles.pred(mod,
                         xname = "ga_wks", xvalues = x,
                         type = c("centiles"), cent = cents, data = dat)

  # compare the centile curves
  plot(y_fpr_mod[,1], y_fpr_mod[,2],
       
       ylim = c(5, 18),
       
       type="n",
       
       xlab = "Gestational week", ylab = "Hemoglobin (g/dL)",
       
       main = paste0("Excluding ", s))
  
  for(i in 2:(length(cents)+1)) {
    lines(y_fpr_mod[,1], y_fpr_mod[,i], col = "black", lty = "longdash")
    lines(y_mod[,1], y_mod[,i], col = "red")
  }
}


newpar <- par(mfrow = c(1,1), mar = par("mar") + c(0, 1, 0, 0),
              col.axis = "blue4", col = "blue4", col.main = "blue4",
              col.lab = "blue4", pch = "+", cex = 0.45, cex.lab = 2,
              cex.axis = 2, cex.main = 2)
# remove preterm
fpr_mod_sensitive_gh("preterm")
par(newpar)
```

Check if the centile plots overlaps by removing the group with preterm delivery. 